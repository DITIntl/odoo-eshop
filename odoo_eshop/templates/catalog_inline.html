{% extends 'base.html' %}


{% block container %}
<!-- JQuery -->
<script>
    $('#nav_catalog_inline').addClass('active');
</script>


<!-- Header -->
<h1>{{ _('Products List') }}</h1>

<!-- Categories -->
{% if categories|length %}

    {% for category in categories %}
        {% if category.available_product_qty != 0 %}
<hr />
<div class="row">
    <div class="col-md-2">
        <div>
            <h2>{{ category.name }}</h2>
            <img class="thumbnail img-responsive" src="data:image/png;base64,{{ category.image_medium }}"/>
        </div>
    </div>
    <div class="col-md-10">

            {% for product in category.product_ids %}
        <div class="row">
            <div class="col-md-1">
                <img class="thumbnail img-responsive" src="data:image/png;base64,{{ product.image_small }}"/>
            </div>
            <div class="col-md-3">
                <a href="{{url_for('product', product_id=product.id)}}">{{ product.name }}</a>
            </div>
            <div class="col-md-2">
                {{ product.list_price|currency }} / {{ product.uom_id }}
            </div>
            <div class="col-md-5">
                <form class="form-inline" role="form" method="POST" action="{{ url_for('catalog_inline_quantity_update') }}">
                    <div class="form-group">
                        <input type="hidden" name="product_id" value="{{ product.id }}"/>
                        <div class="col-md-1">
                            <input type="text" class="form-control quantity"
                                id="quantity_{{product.id}}"
                                name="new_quantity" value="{{ product.id|get_current_quantity }}">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-default update_btn">Update</button>
                </form>
            </div>
        </div>
            {% endfor %}

    </div>
</div>
        {% endif %}
    {% endfor %}

{% endif %}

<!-- JQuery -->
<script>
    $('.update_btn').hide();
    $('.update_btn').attr('disabled', 'disabled');
    
    $('.quantity').change(function(e){
        self = this;
        var new_quantity = e.currentTarget.value;
        var product_id = e.currentTarget.id.split('_')[1];
        console.log(new_quantity);
        console.log(product_id);
        
        $.ajax({
            url: "{{ url_for('catalog_inline_quantity_update') }}",
            type: "POST",
            data: {new_quantity: new_quantity, product_id: product_id},
            timeout: 1000,
        }).done(function(msg){
            console.log(msg);
            if (msg.result.state == 'success' || msg.result.state == 'warning'){
                $('#quantity_' + product_id).val(msg.result.quantity);
                if (msg.result.amount_total == '0') {
                    $('#nav_shopping_cart').css('visibility', 'hidden');
                }
                else {
                    $('#nav_shopping_cart').css('visibility', 'visible');
                    $('#nav_amount_total').replaceWith("<span id='nav_amount_total'>" + msg.result.amount_total + "</span>");
                }
            }
            if (msg.result.state != 'success') {
                $('.flashes').replaceWith("<div class='flashes'><p class='text-center bg-" + msg.result.state + "'>" + msg.result.message  + "</p></div>");
            }
            else {
                $('.flashes').replaceWith("<div class='flashes' />");
            }
        }).fail(function(xhr, textstatus){
            $('.flashes').replaceWith("<div class='flashes'><p class='text-center bg-danger'> {{ _('Something wrong occured, please refresh the page.')}}</p></div>");
        });
    });
</script>

{% endblock %}

